version: 2.1


jobs:
  deploy:
    machine: true
    steps:
      
      - checkout
      - add_ssh_keys:
          fingerprints:
            - "2d:4a:02:c1:28:6b:7d:7f:48:a3:5a:df:3b:1d:50:23"
      - run:
          name: Sending Dockerfile To Ansible Server
          command: rsync -ravz --delete /home/circleci/project/* ubuntu@184.169.212.155:.
      - run:
          name: Build Dokcer Image
          command: ssh -o StrictHostKeyChecking=no ubuntu@184.169.212.155 docker build -t test:${CIRCLE_BUILD_NUM} .
      - run:

          name: Docker Image Tagging
          command: ssh -o StrictHostKeyChecking=no ubuntu@184.169.212.155 docker image tag test:${CIRCLE_BUILD_NUM} vishal7500/test:${CIRCLE_BUILD_NUM};
                  ssh -o StrictHostKeyChecking=no ubuntu@184.169.212.155 docker image tag test:${CIRCLE_BUILD_NUM} vishal7500/test:latest;
      - run: 
          name: Docker Image Push
          command: ssh -o StrictHostKeyChecking=no ubuntu@184.169.212.155 docker login --username vishal7500 --password $DOCKERHUB_PASSWORD ;
                    ssh -o StrictHostKeyChecking=no ubuntu@184.169.212.155 docker push vishal7500/test:${CIRCLE_BUILD_NUM};
                    ssh -o StrictHostKeyChecking=no ubuntu@184.169.212.155 docker push vishal7500/test:latest;
                    ssh -o StrictHostKeyChecking=no ubuntu@184.169.212.155 docker rmi -f vishal7500/test:latest  vishal7500/test:${CIRCLE_BUILD_NUM};
      - run:
          name: Copy Files form ansible to Kubernetes Server
          command: rsync -ravz --delete /home/circleci/project/* ubuntu@13.57.219.200:.

      # - run:
      #     name: Kubernetes Deployment Using Ansible Server
  example-job:
    docker:
      # replace with your preferred image
      - image: cimg/base:stable
    steps:
      - ms-teams-notifier/report:
          webhook_url: https://txplin.webhook.office.com/webhookb2/a5c71dc8-f8c8-4bf6-ad63-f0af1da64f6f@d7e861c9-d924-4413-86db-05780e928657/IncomingWebhook/4976a1665a8b455d80efb692068ab0c2/3a488709-b1e3-423b-8b68-6d9e403099b1    #     command: ssh -o StrictHostKeyChecking=no ubuntu@184.169.212.155 sudo ansible-playbook ansible.yaml
orbs:
  ms-teams-notifier: oktapodia/ms-teams-notifier@3.0.0  
    
workflows:
  sample:
    jobs:
      - deploy
      - example-job

      
            
